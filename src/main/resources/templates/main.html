<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>SNS</title>
  <link rel="stylesheet" th:href="@{/css/style.css}" />
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div style="height: 20px;"></div>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; max-width: 600px; margin-left: auto; margin-right: auto;">
</div>

<div class="feed-container">
  <div th:each="post : ${posts}" class="post-summary"
       th:onclick="'openPostModal(' + ${post.id} + ')'"
       style="cursor:pointer;">

    <h3 th:text="${post.title}"></h3>
    <p th:text="'작성자: ' + ${post.author}"></p>

    <p>
      <span th:if="${post.updatedAt == null}" th:text="'작성일: ' + ${post.createdAt}"></span>
      <span th:if="${post.updatedAt != null}">
        수정일: <span th:text="${post.updatedAt}"></span>
        <span style="color: #888888;">(수정됨)</span>
      </span>
    </p>

    <div class="post-excerpt" th:text="${post.content}"></div>
  </div>
</div>

<div id="postDetailModal" class="modal" style="display:none;">
  <div id="modalContent" class="modal-content">
  </div>
</div>

<div id="modalCloseBtn" class="close-btn" style="display:none;">닫기 X</div>

<script>
  async function openPostModal(postId) {
    try {
      const response = await fetch('/posts/' + postId + '/modal', {
        credentials: 'include'
      });
      if (!response.ok) throw new Error('Failed to fetch post detail');

      const html = await response.text();
      document.getElementById('modalContent').innerHTML = html;

      document.getElementById('postDetailModal').style.display = 'flex';
      document.getElementById('modalCloseBtn').style.display = 'block';
      document.body.style.overflow = 'hidden';

      initDeleteButton();
      initEditButton();
    } catch (error) {
      alert('게시글 상세 정보를 불러오는데 실패했습니다.');
      console.error(error);
    }
  }

  function initDeleteButton() {
    const deleteBtn = document.querySelector('#modalContent .delete-post-btn');
    if (deleteBtn) {
      deleteBtn.onclick = async function () {
        const postId = this.getAttribute('data-post-id');
        console.log("삭제 버튼 클릭됨, postId:", postId);

        if (!confirm('정말로 삭제하시겠습니까?')) return;

        try {
          const response = await fetch('/api/posts/' + postId, {
            method: 'DELETE',
            credentials: 'include',
            headers: {
              'Authorization': 'Bearer ' + getCookie('JWT_TOKEN')
            }
          });

          if (response.ok) {
            alert('게시글이 삭제되었습니다.');
            document.getElementById('postDetailModal').style.display = 'none';
            document.getElementById('modalCloseBtn').style.display = 'none';
            document.body.style.overflow = 'auto';
            location.reload();
          } else {
            const error = await response.text();
            alert('삭제 실패: ' + error);
          }
        } catch (e) {
          console.error(e);
          alert('삭제 중 오류 발생');
        }
      };
    }
  }

  function initEditButton() {
    const editBtn = document.querySelector('#modalContent .edit-post-btn');
    const saveBtn = document.querySelector('#modalContent .save-post-btn');
    const titleEl = document.querySelector('#modalContent .post-title');
    const titleInput = document.querySelector('#modalContent .edit-title-input');
    const contentEl = document.querySelector('#modalContent .post-content');
    const contentInput = document.querySelector('#modalContent .edit-content-input');

    if (!editBtn || !saveBtn || !titleEl || !titleInput || !contentEl || !contentInput) return;

    editBtn.onclick = function () {
      titleEl.style.display = 'none';
      contentEl.style.display = 'none';
      titleInput.style.display = 'block';
      contentInput.style.display = 'block';
      editBtn.style.display = 'none';
      saveBtn.style.display = 'inline-block';
    };

    saveBtn.onclick = async function () {
      const postId = this.getAttribute('data-post-id');
      const updatedTitle = titleInput.value;
      const updatedContent = contentInput.value;

      try {
        const response = await fetch('/api/posts/' + postId, {
          method: 'PUT',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getCookie('JWT_TOKEN')
          },
          body: JSON.stringify({ title: updatedTitle, content: updatedContent })
        });

        if (response.ok) {
          alert('게시글이 수정되었습니다.');

          titleEl.textContent = updatedTitle;
          contentEl.textContent = updatedContent;

          titleEl.style.display = 'block';
          contentEl.style.display = 'block';
          titleInput.style.display = 'none';
          contentInput.style.display = 'none';
          editBtn.style.display = 'inline-block';
          saveBtn.style.display = 'none';
        } else {
          const error = await response.text();
          alert('수정 실패: ' + error);
        }
      } catch (e) {
        console.error(e);
        alert('수정 중 오류 발생');
      }
    };
  }

  function getCookie(name) {
    const cookieStr = document.cookie;
    const cookies = cookieStr.split(';').map(c => c.trim());
    for (const cookie of cookies) {
      if (cookie.startsWith(name + '=')) {
        return decodeURIComponent(cookie.split('=')[1]);
      }
    }
    return null;
  }

  document.getElementById('modalCloseBtn').addEventListener('click', function () {
    document.getElementById('postDetailModal').style.display = 'none';
    this.style.display = 'none';
    document.body.style.overflow = 'auto';
  });

  window.addEventListener('click', function(event) {
    const modal = document.getElementById('postDetailModal');
    const closeBtn = document.getElementById('modalCloseBtn');
    if (event.target === modal) {
      modal.style.display = 'none';
      closeBtn.style.display = 'none';
      document.body.style.overflow = 'auto';
    }
  });
</script>
</body>
</html>
